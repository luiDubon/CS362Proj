#include <LiquidCrystal.h>
#include <Adafruit_NeoPixel.h>

// ---------------- LCD SETUP ----------------

// LCD pin mapping: RS, E, D4, D5, D6, D7
LiquidCrystal lcd(12, 11, 5, 4, 3, 2);

const int LCD_COLS = 16;
const int LCD_ROWS = 2;

// Scrolling welcome message
String welcomeMsg = "   Welcome to the game!   ";

int scrollIndex = 0;
unsigned long lastScrollTime = 0;
const unsigned long scrollInterval = 400;  // SLOWER

// Custom bottom line text when idle
String bottomLine = "Press start --->";

String incomingLine = "";
bool haveNewMessage = false;

// ---------------- GAME STATE ----------------
const int STATE_IDLE    = 0;
const int STATE_PLAYING = 1;
const int STATE_WIN     = 2;
const int STATE_LOSE    = 3;

int gameState = STATE_IDLE;

int currentScore = 0;
int highScore    = 0;

bool isGameOver  = false;
bool isWinState  = false;

// ---------------- RGB STRIP SETUP ----------------

#define LED_PIN 7
#define NUM_LEDS 30   // Change to your number of LEDs

Adafruit_NeoPixel strip(NUM_LEDS, LED_PIN, NEO_GRB + NEO_KHZ800);
unsigned long lastColorTime = 0;
uint16_t colorWheelPos = 0;

// ---------------- FUNCTION DECLARATIONS ----------------
void handleMasterMessage(const String &msg);
void startGame();
void resetGame();
void updateScore(int score);
void setWin(int score);
void setLose(int score);
void showScoreScreen();

// ---------------- SETUP ----------------

void setup() {
  // LCD
  lcd.begin(LCD_COLS, LCD_ROWS);
  Serial.begin(9600);

  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Loading...");
  lcd.setCursor(0, 1);
  lcd.print(bottomLine);

  // RGB strip
  strip.begin();
  strip.setBrightness(40);   // dimmer LEDs (0–255)
  strip.show();
}

// ---------------- MAIN LOOP ----------------

void loop() {
  // 1) Read any incoming command from master
  readSerialInput();

  if (haveNewMessage) {
    handleMasterMessage(incomingLine);
    incomingLine = "";
    haveNewMessage = false;
  }

  // 2) When idle, keep showing scrolling welcome
  if (gameState == STATE_IDLE) {
    scrollWelcomeMessage();
  }

  // 3) RGB animation always running
  fadeRGBStrip();
}

// ---------------- SERIAL HANDLING ----------------

void readSerialInput() {
  while (Serial.available() > 0) {
    char c = Serial.read();

    if (c == '\n' || c == '\r') {
      if (incomingLine.length() > 0) {
        incomingLine.trim();
        haveNewMessage = true;
      }
      return;
    } else {
      incomingLine += c;
      if (incomingLine.length() > 64)
        incomingLine = incomingLine.substring(0, 64);
    }
  }
}

// Interpret commands from master:
//  "START"
//  "RESET"
//  "SCORE:12"
//  "WIN:45"
//  "LOSE:10"
void handleMasterMessage(const String &msg) {
  if (msg.length() == 0) return;

  int sep = msg.indexOf(':');
  String cmd;
  String arg;

  if (sep == -1) {
    cmd = msg;
    arg = "";
  } else {
    cmd = msg.substring(0, sep);
    arg = msg.substring(sep + 1);
    arg.trim();
  }

  cmd.toUpperCase();  // convert to upper-case for comparison

  if (cmd == "START") {
    startGame();
  } else if (cmd == "RESET") {
    resetGame();
  } else if (cmd == "SCORE") {
    int s = arg.toInt();
    updateScore(s);
  } else if (cmd == "WIN") {
    int s = arg.toInt();
    setWin(s);
  } else if (cmd == "LOSE") {
    int s = arg.toInt();
    setLose(s);
  } else {
    // Unknown command → just display raw text
    displayIncomingMessage(msg);
  }
}

// ---------------- GAME STATE FUNCTIONS ----------------

void startGame() {
  gameState  = STATE_PLAYING;
  isGameOver = false;
  isWinState = false;
  currentScore = 0;

  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Game started!");
  lcd.setCursor(0, 1);
  lcd.print("Good luck :)   ");
}

void resetGame() {
  gameState  = STATE_IDLE;
  isGameOver = false;
  isWinState = false;
  currentScore = 0;

  lcd.clear();
  // scrollWelcomeMessage() will take over in loop
}

void updateScore(int score) {
  currentScore = score;
  if (currentScore > highScore) {
    highScore = currentScore;
  }

  if (gameState == STATE_PLAYING) {
    showScoreScreen();
  }
}

void setWin(int score) {
  currentScore = score;
  if (currentScore > highScore) {
    highScore = currentScore;
  }

  gameState  = STATE_WIN;
  isGameOver = true;
  isWinState = true;

  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print(" YOU WIN!      ");

  lcd.setCursor(0, 1);
  lcd.print("S:");
  lcd.print(currentScore);
  lcd.print("  Hi:");
  lcd.print(highScore);
}

void setLose(int score) {
  currentScore = score;
  if (currentScore > highScore) {
    highScore = currentScore;   // keep best score even on loss
  }

  gameState  = STATE_LOSE;
  isGameOver = true;
  isWinState = false;

  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print(" YOU LOSE!     ");

  // Show score + high score on lose
  lcd.setCursor(0, 1);
  lcd.print("S:");
  lcd.print(currentScore);
  lcd.print("  Hi:");
  lcd.print(highScore);
}

void showScoreScreen() {
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Playing...     ");

  lcd.setCursor(0, 1);
  lcd.print("S:");
  lcd.print(currentScore);
  lcd.print("  Hi:");
  lcd.print(highScore);
}

// ---------------- DISPLAY MESSAGE ON LCD (fallback) ----------------

void displayIncomingMessage(const String &msg) {
  lcd.clear();

  String line1 = msg.substring(0, min(LCD_COLS, msg.length()));
  String line2 = "";

  if (msg.length() > LCD_COLS) {
    line2 = msg.substring(LCD_COLS, min(2 * LCD_COLS, msg.length()));
  }

  lcd.setCursor(0, 0);
  lcd.print(padOrTrim(line1, LCD_COLS));

  lcd.setCursor(0, 1);
  lcd.print(padOrTrim(line2, LCD_COLS));
}

String padOrTrim(String s, int n) {
  if ((int)s.length() > n) {
    return s.substring(0, n);
  }
  while ((int)s.length() < n)
    s += " ";
  return s;
}

// ---------------- SCROLLING TEXT (IDLE SCREEN) ----------------

void scrollWelcomeMessage() {
  unsigned long now = millis();
  if (now - lastScrollTime < scrollInterval) {
    return;
  }
  lastScrollTime = now;

  String window = "";
  int len = welcomeMsg.length();

  for (int i = 0; i < LCD_COLS; i++) {
    int idx = (scrollIndex + i) % len;
    window += welcomeMsg[idx];
  }

  lcd.setCursor(0, 0);
  lcd.print(window);

  lcd.setCursor(0, 1);
  lcd.print(bottomLine);

  scrollIndex++;
  if (scrollIndex >= len) {
    scrollIndex = 0;
  }
}

// ---------------- RGB FADE FUNCTION ----------------

void fadeRGBStrip() {
  unsigned long now = millis();

  // Adjust speed (bigger = slower)
  if (now - lastColorTime < 20)
    return;

  lastColorTime = now;

  uint32_t color = strip.ColorHSV(colorWheelPos * 256);
  strip.fill(color);
  strip.show();

  colorWheelPos++;
  if (colorWheelPos >= 255)
    colorWheelPos = 0;
}
